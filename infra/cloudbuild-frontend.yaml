# cloudbuild-frontend.yaml
options:
  logging: CLOUD_LOGGING_ONLY

substitutions:
  _REGION: asia-south1
  _REPO: manthan-repo
  _SERVICE: manthan-frontend
  _PROJECT: project-manthan-468609
  _IMAGE: $_REGION-docker.pkg.dev/$_PROJECT/$_REPO/$_SERVICE:$COMMIT_SHA
  _API_BASE: https://manthan-backend-$_REGION.run.app

steps:
- name: gcr.io/cloud-builders/npm
  dir: apps/web
  args: ["npm", "i", "-g", "pnpm"]

- name: gcr.io/cloud-builders/npm
  dir: .
  args: ["pnpm", "i"]

- name: gcr.io/cloud-builders/docker
  args: ["build", "-f", "apps/web/Dockerfile", "-t", "$_IMAGE", "apps/web"]

- name: gcr.io/cloud-builders/docker
  args: ["push", "$_IMAGE"]

- name: gcr.io/google.com/cloudsdktool/cloud-sdk
  entrypoint: gcloud
  args:
    - run
    - deploy
    - $_SERVICE
    - --image=$_IMAGE
    - --region=$_REGION
    - --project=$_PROJECT
    - --allow-unauthenticated
    - --set-env-vars=NEXT_PUBLIC_API_BASE=$_API_BASE
    - --set-env-vars=NEXT_PUBLIC_POSTHOG_KEY=
    - --set-env-vars=NEXT_PUBLIC_POSTHOG_HOST=https://app.posthog.com
    - --set-env-vars=NEXT_PUBLIC_FIREBASE_API_KEY=
    - --set-env-vars=NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=
    - --set-env-vars=NEXT_PUBLIC_FIREBASE_PROJECT_ID=$_PROJECT
    - --set-env-vars=NEXT_PUBLIC_FIREBASE_APP_ID=
    - --set-env-vars=NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=manthan-assets
    - --set-env-vars=NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=
    - --cpu=1
    - --memory=512Mi
